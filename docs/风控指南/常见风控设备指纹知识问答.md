# 常见风控设备指纹知识问答

## 设备指纹

设备id：设备的唯一标识

设备指纹：生成设备id的产品和技术，称为设备指纹

![img](https://996station.com/wp-content/uploads/2022/11/20221120032502904.png?imageView2/0/format/webp/q/75)

原理：通过采集客户端的特征属性信息并将其加密上传到云端，然后通过特定的算法分析并为每台设备生成唯一的id来标识这台设备

要求：稳定性、唯一性、安全性、易用性、高性能

挑战：个人隐私安全约束导致无法采集所有信息，android系统api参差不齐导致无法采集存在各种兼容

### 稳定性

稳定性的定义：同一设备升级或者部分要素的变更，设备指纹码不会发生改变，多重要素关联决策提升稳定性。

要求：

| 设备     | 客户端               | 要求                                                         |
| -------- | -------------------- | ------------------------------------------------------------ |
| 移动设备 | android，ios，小程序 | 同设备不同应用，设备id不变 同设备卸载重装，设备id不变ios设备重置IDFA后，设备id不变改机软件修改属性后，设备id不变 |
| PC设备   | web                  | 同浏览器跨域名访问，设备id不变 更改代理，修改分辨率，设备id不变清cookie，修改ua，设备id不变匿名使用，设备id不变 |

Android系统中稳定的设备参数

| 采集项        | 释义                                    | 特性                        |
| ------------- | --------------------------------------- | --------------------------- |
| AndroidID     | 首次启动是系统生成的随机数              | 不需要权限 恢复出厂会重置   |
| IMEI/MEID     | 设备码，移动/联通获取IMEI，电信获取MEID | 唯一性好 没有卡槽则获取不到 |
| IMSI          | 手机SIM卡识别码                         | 换sim卡会变                 |
| WiFi-MAC      | 网卡MAC地址                             |                             |
| Bluetooth-MAC | 蓝牙MAC地址                             |                             |
| Serial        | 设备串号                                |                             |
| Fingerprint   | 设备的多个硬件信息拼接合成              |                             |
| Storage       | 内存空间                                |                             |
| AdvertisingID | 谷歌广告ID                              |                             |

iOS系统中稳定的设备参数

| 采集项     | 释义         | 特性       |
| ---------- | ------------ | ---------- |
| IDFA       | 广告标识符   |            |
| IDFV       | 厂商标识符   |            |
| DeviceName | 收集名称     | 可自行修改 |
| WiFi-MAC   | 网卡mac地址  | 唯一性好   |
| Boottime   | 系统开机时间 | 重启会变   |
| Stroage    | 内存空间     |            |

浏览器中稳定的设备参数

| 采集项     | 释义                 | 特性         |
| ---------- | -------------------- | ------------ |
| UserAgent  | 浏览器客户端标识     | 可以任意修改 |
| GPU        | 设备GPU特性          |              |
| Canvas     | 2D指纹               | 唯一性好     |
| Webgl      | 3D指纹               |              |
| PluginList | 插件列表             |              |
| FontList   | 字体列表             |              |
| IP         | 内网IP、外网IP       |              |
| TCP        | 不同操作系统协议差异 | 不容易被修改 |

### 唯一性

唯一性定义：通过多要素采集，通过条件概率、联合概率及置信度算法综合决策，保障不同设备生成的id不会重复，确保设备标识的唯一性。

![img](https://996station.com/wp-content/uploads/2022/11/20221120032839839.png?imageView2/0/format/webp/q/75)

local设备id：客户端本地生成的设备id

server设备id：服务端生成的设备id

### 安全性

必要性：通过SDK采集客户端信息的工作方式，必须嵌入APP应用或者H5页面中，直接暴露在黑产眼前。黑产可以通过逆向分析和修改SDK采集的设备信息字段来试探云端风控策略，也可以制作工具针对性的伪造大量虚假设备用于后续攻击活动。SDK的破解只是时间问题，所以我们需要对SDK进行安全加固保护，提升黑产破解的难度和提高花费的时间成本。

安全性定义：前端通过对采集要素进行各种算法校验及外码加密传输，防止参数被篡改；通过对采集字段混淆、采集脚本混淆、外码动态过期等机制保障防盗用；后端通过对参数验签、接口防作弊识别保障安全可用。

![img](https://996station.com/wp-content/uploads/2022/11/20221120032845280.png?imageView2/0/format/webp/q/75)

| 要求   | 特性                                                         |
| ------ | ------------------------------------------------------------ |
| 防篡改 | 采集要素算法校验 校验算法动态变更内外码加密传输              |
| 防盗用 | 客户端代码混淆 采集字段混淆混淆方式动态变更外码随时过期时间，动态变更 |
| 防作弊 | 参数验签 作弊侦测采集要素完整性校验                          |

代码混淆是增加黑产静态分析难度而牺牲运行效率的一种技术方案。

JS代码加固技术（以Collberg为理论基础）：

- 布局混淆：
  - 删除无效代码：注释文本，调试信息，无用函数和数据，缩进和换行符
  - 标识重命名：将常量名、变量名、函数名 修改为无意义，难以阅读的名字
- 数据混淆：
  - 数字混淆：进制转换、数字拆解
  - 布尔混淆
- 控制混淆：对程序的控制流进行变换，更改程序中原有的控制流达到让代码非常难以阅读和理解为目的。
  - 不透明谓词
  - 插入冗余代码
  - 控制流平坦化
- 预防混淆：提高现有的反混淆技术破解代码的难度或检测现有反混淆器中存在的问题。

Android/iOS SDK加固保护：

- 变量名和函数名混淆：Proguard是一款Java语言的压缩器、优化器、混淆器，能够检测并删除未使用的类、变量、方法、属性；分析并优化方法的字节码；将实际使用的类、变量、方法重命名为无意义的短名称，使字节码更小、高效，并难以逆向分析。混淆不会改变源代码逻辑，只会使得反编译出来的代码不易阅读。Android支持在编译过程中的Proguard。
- 字符串混淆：将函数字符串进行加固，通过加密字符串使得难以找到上游函数
- Dex加固与抽取：将需要保护的代码单独生成Dex
- Dex抽取：将Dex字节码中的函数代码片段单独提取出来，生成一个方法结构体为空Dex，并将代码片段保存在so中
- LLVM
- 代码虚拟化：代码虚拟化技术是一种比Dex文件保护，Java2c技术更强的安全防护技术，可以更有效地对抗黑产逆向工程和破解，避免造成核心技术和风控逻辑被泄密的问题。

### 易用性

设备指纹生成服务支持云方式使用或本地化部署，JS无感知嵌入，SDK客户端接口方便易调用，服务器资源低消耗，普通服务即可支持。

### 高性能

合理设计，合理的资源使用支持高性能、横向扩展。高并发单节点支持5000PS，与业务流水弱相关，支持随业务量的水平横向扩展，99.9%的请求可以在100ms以内返回。

## 设备画像

### 画像的定义

什么是用户画像呢？

可能大家看到过一些外文资料或者演讲中出现过profile一词，其实和画像是一个概念，都是从不同的维度来表达一个人，这些维度可以是事实的，可以是抽象的；可以是自然属性，比如性别、年龄；可以是社会属性，比如职业、社交特征；可以是财富状况，比如是否高收入人群，是否有固定资产；可以是家庭情况，比如是否已经结婚，是否有孩子；可以是购物习惯，比如喜欢网购还是喜欢逛商场；可以是位置特征，比如在哪个城市生活；可以是其他行为习惯。总之，所有大家能想到的描述一个人的特征的都可以算作是画像的范畴，画像其实就是想方设法用数据来描述人的特征。

设备画像：

设备画像作为用户画像的一个子维度，主要是通过SDK采集信息，将采集信息进行分析和挖掘，用以描述设备的特征。有了设备画像之后，我们就可以对设备进行风险防控。

### 设备画像

根据对设备属性的了解，我们大致可以将设备画像分为

- 虚拟设备：刻画设备虚实，大多的黑灰产会利用虚拟设备充当真机进行低成本作恶
- 异常环境：刻画设备异常状态，比如当前是否已经root
- 风险工具：描述设备是否安装了风险的应用和工具
- 农场设备：挖掘设备的使用者背后所属的群组关系

| 一级分类 | 二级分类            | 释义                   | 举例                 |
| -------- | ------------------- | ---------------------- | -------------------- |
| 虚拟设备 | 模拟器              | 运行在PC上的模拟器     | 雷电模拟器，MUMU     |
|          | 云手机              | 运行在云端上的模拟器   | 红手机，华为云手机   |
|          | 多开环境            | 通过多开运行应用       | 多开助手             |
| 异常环境 | hook                | hook劫持               |                      |
|          | root                | 安卓root、苹果越狱     |                      |
|          | 调试模式            | 开启调试模式           |                      |
|          | 辅助服务            | 开启辅助服务           |                      |
|          | 工程模式            |                        |                      |
|          | sim空               |                        |                      |
| 风险工具 | 改机工具            | 修改设备信息           |                      |
|          | 自动化脚本          | 自动化可编程的操作脚本 | 按键精灵，自动连点器 |
|          | 接码工具            | 用于接收短信验证码     |                      |
|          | 网赚软件            | 识别真人薅羊毛         | 众人帮，人人赚       |
|          | VPN工具             |                        |                      |
|          | 多开工具            | 安装多开工具           | 一键分身             |
|          | 群控工具            |                        |                      |
| 农场设备 | 农场设备/工作室设备 |                        |                      |

### 采集信息

要想获得以上的画像，就需要依赖SDK采集的信息，这里涉及敏感内容，故不将采集列表展示出来。可以根据自身对画像的需要，去找依赖的属性。

一般采集内容包含：

- 基本属性：品牌，机型，启动时间，出厂标识 等
- 硬件属性：cpu，内存，分辨率，亮度，篡改器，摄像头，电池，陀螺仪，蓝牙 等
- 网络相关：WiFi名称，WiFi-mac，sim卡，imei，信号强度，基站信息， 等
- 安装属性：自带应用，安装应用 等
- 其他属性：手机名称，输入法，idfa，idfv，系统语言 等
- 等等

### 欺诈检测方法

| 终端    | 方法                                                         |
| ------- | ------------------------------------------------------------ |
| Android | 通过安装包检测安装的作弊工具 通过特定特征识别root环境使用多种方案采集同一字段信息识别作弊框架hook识别作弊工具和模拟器 |
| iOS     | 通过通用hook原理识别技术检测运行的作弊工具 通过特定作弊工具特征识别运行的作弊工具通过特定特征识别越狱环境寻找特定的空间存储设备标识对抗hook改机对抗备份和抹机 |
| Web     | 识别浏览器端异常环境 通过特定特征识别hook通过特定特征识别JS是否被篡改或者正在被调试通过浏览器特殊方式存储设备标识，防止存储的标识被删除 |



## 高强度对抗指纹表现

1.设备风控不仅仅包含设备指纹这一项，还有例如对设备是否ROOT、设备是否被修改(Xposed/rida/等等更全面的信息采集。

2.设备指纹在高强度对抗的情况下，确实意义不大。从定制Hook框架到定制ROM，以致于到了更底层Linux内核的修改后，设备指纹其实已经失去了原本的意义。但不可否认的是，设备指纹对于增加黑产对抗难度和某些特定场景的标识，还是具有一定作用的。

任何一层均有黑产作案的可能性。

3.从实际业务出发点来看，很多的地方是需要依靠设备风控来实现的。最常见的场景莫过于广告和电商及社交，这种场景下可以采集用户的信息比较少，也不可能采用交互式的风控方法（你总不可能用户看个广告让人家输个验证码吧 -_-），就只能依靠于设备风控做对抗。

## 在高强度对抗的场景下，设备风控该怎么做？

在上升到对ROM和Linux内核的修改以及专门针对App风控采集的行为去分析的对抗强度后，从理论上来说貌似App风控系统从用户端采集的如何参数都已经不可信了，因为从理论上来说一切可以采集的参数均是来自于系统接口、内核接口以及特定的行为痕迹，综上所述一切参数在特定情况下都是可伪造的。

在设备风控这个领域，从最初简单的设备指纹、存储ID到本地文件这种简单方法，到后来出现的采集很多ID参数云端识别，再到现在的基于设备的非标识性参数进行关联分析的方案，黑产和风控的对抗是一步步不断进化和不断迭代的过程。

## 什么是基于非标识性参数的关联分析识别？

  所谓的基于非标识性参数的关联分析识别，就是基于多个不带标识类的参数进行配合识别的技术，行业内常称为‘关联检测’。

## 什么是非标识类参数？

举个粒子，IMEI、MAC地址、Android ID这一类本身对设备的具有唯一性、标识性的参数，称为标识符类参数，或者称为唯一标识码。非标识类参数就是除了上述类型以外的，不具有唯一性或者标识性的设备参数。

### 常见的非标识性参数：

通用：网络类型(WiFi/4G/3G)、WiFi接入点名称（Wifi SSID）、移动网络信息（运营商、接入点名称）、GPS/基站定位、电池电量信息、文件系统信息（空间大小）、内存大小

Android特有：boot_id、存储分区大小/inodes/block数量、getPackageInfo()->firstInstallTime、设备名称

## 怎么关联分析？

![img](https://996station.com/wp-content/uploads/2022/11/20221120024004339.png?imageView2/0/format/webp/q/75)

理论原理：

  1.假设一台设备的IMEI和MAC地址被人为抹去修改了（数据库中无法找到这个imei曾经存在过），但是数据库中有一台设备的bootId、电池电量、GPS定位信息与这个数据高度重合了，是可以判定为同一台设备。

  2.基于假设1出现另一台基于标识性参数去识别而无历史数据的手机，并且数据库中也无其他数据能和该设备数据重合，则判定为新设备。



  3.基于概率学理论，只要你采集的可比对参数越多，那么同一台设备重合性就越大，相应的不同一台设备重合的可能性就越小。所以假设1和假设2都可以基于一个固定的重合度的阈值，通过程序来计算是否达到阈值而判定是否重合。

基于以上理论大家应该就能很好的理解该方法的原理，其实无非就是尽可能的采集更多的参数，在云端生成设备指纹的时候把该设备指纹的数据存储起来，在下一次遇到没有标识性数据的时候，则采用对比非标识性数据的重合度的。

识别原理

来自参考：《知物由学 | 从应用端到服务端，设备指纹生成算法大变革》 --网易

## 关联检测的意义在于什么？

随着Google对Android的隐私权限管理的一步步收紧，未来从Android端能够采集的标识性参数将会越来越少，加上本身iOS端就没有多少可以采集的标识性参数，未来设备风控将会逐步转向到基于非标识性参数的关联检测方向中去。

安卓10后的全新权限控制框架：

Android新权限框架

而且目前现有的关联检测还仅仅是停留在固定算法判定的简单模式下，如果有机器学习/深度学习这类能力的人，完全可以通过引入AI模型去代替重合算法，做出更强的识别方式。

## 总结

黑产对抗是一个不断更新迭代的过程，要用创新的思维去看待问题，才能使自己不断进步，固步自封只会让自己立于尴尬之地。



## 参考：

https://zhuanlan.zhihu.com/p/465692284

《风控要略》

[安全客季刊 - 设备指纹指南](https://link.zhihu.com/?target=http%3A//static.anquanke.com/download/b/security-geek-2020-q3/article-14.html)

[邦盛风控反欺诈：设备指纹，看这篇就够了！](https://zhuanlan.zhihu.com/p/338928808)